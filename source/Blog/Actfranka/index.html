
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Vision Guided Imitation Learning using Action Chunk Transformer &#8212; Portfolio  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=d9d6623f" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'source/Blog/Actfranka/index';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
    <script src="../../../_static/custom.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Isaac Sim" href="../isaacsim/index.html" />
    <link rel="prev" title="Blog" href="../Bluetooth/index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Navaneet</p>
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sainavaneet" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.linkedin.com/in/sainavaneet76/" title="LinkedIn" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
            <span class="sr-only">LinkedIn</span></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    Bio
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../Resume/index.html">Resume</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../projects/index.html">Projects</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../projects/Tissue-processing/index.html">Transformer Based Vision Guided Tissue Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/Autonomus%20Harvesting/index.html">üéâ Autonomus harvesting using Object Detecion</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../projects/TelloDrone%20with%20KeyBoard/index.html">TelloDrone with Keyboard and Object Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/Basic-reinforcment-Learning/index.html">Basic Reinforcement Learning Algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/Deep%20Neural%20Network%20Nonlinear%20Model%20Predictive%20Control%20for%20CSTR/index.html">Deep Neural Network Nonlinear Model Predictive Control for CSTR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/Drone%20Control%20with%20Keyboard/index.html">Drone Control with Keyboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/Drone%20Trajectory%20Tracking/index.html">Drone Trajectory Tracking with Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/Imitation-Learning-Franka/index.html">Combining Imitation Learning with Diffusion Processes on Robot Manipulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/LMPC-ILC/index.html">Hybrid Model Predictive and Iterative Learning Control for Enhanced Leader-Follower Robotic Tracking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/32%20bit%20CPU%20based%20on%20MIPS%20architecture/index.html">32 bit CPU based on MIPS architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/Smart%20Home%20Using%20Iot/index.html">Smart-Home-Using-IOT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../projects/Verilog/index.html">Verilog Projects</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../experience/index.html">üë®‚Äçüíª Experience</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../publications/index.html">Publications</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../Bluetooth/index.html">Blog</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Vision Guided Imitation Learning using Action Chunk Transformer</a></li>




<li class="toctree-l2"><a class="reference internal" href="../isaacsim/index.html">Isaac Sim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../go2_robot_isaacsim/index.html">üêæ Go2 Robot in Isaac Sim (Omniverse)</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../Contact/index.html">Contact Me</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/source/Blog/Actfranka/index.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Vision Guided Imitation Learning using Action Chunk Transformer</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Vision Guided Imitation Learning using Action Chunk Transformer</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#transformer">Transformer</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#encoder">Encoder</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-head-attention">Multi-head Attention</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decoder">Decoder</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#main-overview-of-the-act">Main Overview of the ACT</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1">STEP 1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2">STEP 2</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#system-overview">System Overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-input-and-cnn-processing">Image Input and CNN Processing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-tokenization-and-transformer-encoding">Feature Tokenization and Transformer Encoding</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decoding-and-output-prediction">Decoding and Output Prediction</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#temporial-ensembling">Temporial Ensembling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#action-chunking">Action Chunking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#action-chunking-with-temporal-ensembling">Action Chunking with Temporal Ensembling</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#algorithm">Algorithm</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#code">CODE</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#datset-prepare">Datset Prepare</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset-sampler">Dataset Sampler</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#policy">Policy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-code">Training code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model">Model</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="vision-guided-imitation-learning-using-action-chunk-transformer">
<h1>Vision Guided Imitation Learning using Action Chunk Transformer<a class="headerlink" href="#vision-guided-imitation-learning-using-action-chunk-transformer" title="Link to this heading">#</a></h1>
<p>The Action Chunking with Transformers (ACT) technique in single-arm robotic manipulation for vision-guided pick-and-place tasks. ACT employs a Conditional Variational Autoencoder (CVAE) to predict sequences of actions, termed ‚Äúaction chunks,‚Äù which are groups of actions predicted together to achieve more complex tasks efficiently. Unlike traditional methods that rely solely on joint position data and predict individual actions, our approach integrates visual data to enrich the learning context and enhance execution precision. We acquired the expert data by providing manual demonstrations of the task, allowing the model to learn from real-time, complex action sequences. By predicting these action chunks instead of single actions, the ACT model adapts from dual-arm to single-arm configurations, enhancing control strategies and demonstrating significant improvements in the robot‚Äôs speed, precision, and reliability. This substantiates the paper‚Äôs title, ‚ÄúVision-Guided Imitation Learning Using Action Chunk Transformers,‚Äù highlighting the critical role of vision in advancing robotic control systems.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="transformer">
<h1>Transformer<a class="headerlink" href="#transformer" title="Link to this heading">#</a></h1>
<p>This is from the main paper <code class="docutils literal notranslate"><span class="pre">&quot;Attention</span> <span class="pre">is</span> <span class="pre">all</span> <span class="pre">you</span> <span class="pre">need</span> <span class="pre">&quot;</span></code> .It‚Äôs designed to encode a sequence into a set of context-aware vector representations, relying heavily on self-attention and position-wise operations, without using recurrence (like RNNs) or convolution.</p>
<p><img alt="" src="../../../_images/clipboard-3868909561.png" /></p>
<p>The transformer architecture is divided into two parts.</p>
<ol class="arabic simple">
<li><p>Encoder</p></li>
<li><p>Decoder</p></li>
</ol>
<section id="encoder">
<h2>Encoder<a class="headerlink" href="#encoder" title="Link to this heading">#</a></h2>
<p><img alt="" src="../../../_images/clipboard-2502854223.png" /></p>
<p>First of all the encoder transforms the input tokens into continuous embeddings and adds positional encodings, resulting in a sequence of vectors that now carry both semantic and positional information.</p>
</section>
<section id="multi-head-attention">
<h2>Multi-head Attention<a class="headerlink" href="#multi-head-attention" title="Link to this heading">#</a></h2>
<p><img alt="" src="../../../_images/clipboard-962511043.png" /></p>
<ul class="simple">
<li></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-   Take an input embedding with a dimension of 256.

-   Split the embedding into 8 segments, each with a dimension of 32.

-   Pass each segment through its own linear layer.

-   Feed the outputs of these linear layers into the Scaled Dot Product Attention mechanism.

-   **Scaled Dot Product Attention**

$$
\mathrm{Attention}(Q,K,V) = \text{softmax}\!\biggl(\frac{QK^{T}}{\sqrt{d_{k}}}\biggr)V
$$

![](images/clipboard-2936912793.png)
</pre></div>
</div>
<ul class="simple">
<li><p>We concatenate the various segments we initially divided, restoring them to the original input embedding size. This concatenated output is then passed through a Linear layer, which produces the final output of the Attention mechanism.</p></li>
</ul>
</section>
<section id="decoder">
<h2>Decoder<a class="headerlink" href="#decoder" title="Link to this heading">#</a></h2>
<p><img alt="" src="../../../_images/clipboard-1278570773.png" /></p>
<p>The decoder receives the encoder‚Äôs output and feeds it into the multi-headed attention mechanism.</p>
<p>The only change in the decoder is that within its multi-headed attention, the values and keys are sourced from the encoder, while the queries are derived from the decoder‚Äôs preceding output.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="main-overview-of-the-act">
<h1>Main Overview of the ACT<a class="headerlink" href="#main-overview-of-the-act" title="Link to this heading">#</a></h1>
<p><img alt="" src="../../../_images/clipboard-1202681815.png" /></p>
<p>The main architecture of the Action Chunk Transformer incorporates <code class="docutils literal notranslate"><span class="pre">two</span> <span class="pre">distinct</span> <span class="pre">encoders</span></code>. On the <code class="docutils literal notranslate"><span class="pre">left</span> <span class="pre">side</span></code>, one encoder is dedicated to processing action sequences along with position embeddings, which are then integrated into a style variable.</p>
<section id="step-1">
<h2>STEP 1<a class="headerlink" href="#step-1" title="Link to this heading">#</a></h2>
<p><img alt="" src="../../../_images/clipboard-993422171.png" /><strong>Encoding Latent Variations:</strong> The encoder on the left side compresses the action sequence and joint observations into a latent variable <em>z</em>. This variable captures the ‚Äú<code class="docutils literal notranslate"><span class="pre">style</span></code>‚Äù of the action, focusing on unique motion patterns while ignoring specific details.</p>
<p><strong>Facilitating Stochasticity:</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">z</span></code> introduces necessary stochasticity, allowing the model to account for multiple plausible action sequences from the same input, which is vital during training.</p>
<p><strong>Test-Time Simplicity:</strong></p>
<p>At test time, <em><code class="docutils literal notranslate"><span class="pre">z</span></code></em> is set to the mean of its prior distribution, usually zero, to simplify the inference process by:</p>
<ul class="simple">
<li><p>Eliminating the need for random sampling.</p></li>
<li><p>Streamlining the generation of deterministic action sequences.</p></li>
</ul>
<p>In essence, z aids in learning a probabilistic representation of action variations during training but is simplified to a deterministic value at test time.</p>
<p>Finally, the encoder on the right further supports the training process by handling additional aspects of the input data, ensuring comprehensive learning and adaptation by the model.</p>
<p>This structure allows the transformer to manage and learn from complex action sequences in a highly effective manner.</p>
</section>
<section id="step-2">
<h2>STEP 2<a class="headerlink" href="#step-2" title="Link to this heading">#</a></h2>
<p><img alt="" src="../../../_images/clipboard-2424426765.png" /></p>
<section id="system-overview">
<h3>System Overview<a class="headerlink" href="#system-overview" title="Link to this heading">#</a></h3>
<p>The system is designed to process visual input from cameras to predict the movement or configuration of robot joints. It integrates convolutional neural networks (CNNs) and transformers to achieve this, using image data to determine how the robot should adjust its joints.</p>
</section>
<section id="image-input-and-cnn-processing">
<h3>Image Input and CNN Processing<a class="headerlink" href="#image-input-and-cnn-processing" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Input Images</strong>: The input consists of RGB images with a resolution of 640x480 pixels. If there are multiple cameras, each provides an image of this size.</p></li>
<li><p><strong>CNN Backbone (ResNet18)</strong>: The images are first processed by a convolutional neural network (CNN), specifically using ResNet18 as the backbone. This CNN is tasked with extracting relevant features from the raw images. The CNN reduces the spatial dimensions of the image while increasing the depth of features:</p>
<ul>
<li><p><strong>Output Dimension</strong>: After passing through the CNN, the dimensions of each image are reduced to a feature map of 300x512. This size represents a flattened form of the original feature maps, which may initially be spatially structured (e.g., 15x20 pixels with 512 feature channels).</p></li>
</ul>
</li>
</ul>
</section>
<section id="feature-tokenization-and-transformer-encoding">
<h3>Feature Tokenization and Transformer Encoding<a class="headerlink" href="#feature-tokenization-and-transformer-encoding" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Tokenization</strong>: The output from the CNN is considered as a series of tokens. Each pixel in the 300x512 map is treated as an individual token, carrying rich feature information.</p></li>
<li><p><strong>Inputs for Transformer</strong>:</p>
<ul>
<li><p><strong>Observations</strong>: The tokens derived from the CNN output.</p></li>
<li><p><strong>Joint States</strong>: Current or previous states of the robot‚Äôs joints are also inputted into the transformer as a 1x512 vector. This informs the model of the robot‚Äôs current configuration.</p></li>
<li><p><strong>Latent Style Variable <code class="docutils literal notranslate"><span class="pre">z</span></code></strong>: A style variable (also of size 1x512) is included to possibly capture and integrate additional contextual or style-specific information which may influence how the output should be adapted.</p></li>
</ul>
</li>
</ul>
</section>
<section id="decoding-and-output-prediction">
<h3>Decoding and Output Prediction<a class="headerlink" href="#decoding-and-output-prediction" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Decoder</strong>: The decoder part of the transformer then takes the encoded data and, through a series of transformations, predicts the sequence of joint angles. These predictions are formatted as sequences (kx8), where <code class="docutils literal notranslate"><span class="pre">k</span></code> represents different prediction points or time steps, and 8 could represent the number of joints or the dimensionality of each joint‚Äôs output.</p></li>
<li><p><strong>Output</strong>: The final output is a sequence predicting how the joints should move or be positioned based on the visual input and the given conditions (latent variables and joint states).</p></li>
</ul>
</section>
</section>
<section id="temporial-ensembling">
<h2>Temporial Ensembling<a class="headerlink" href="#temporial-ensembling" title="Link to this heading">#</a></h2>
<p><img alt="" src="../../../_images/clipboard-3830263335.png" /></p>
<section id="action-chunking">
<h3>Action Chunking<a class="headerlink" href="#action-chunking" title="Link to this heading">#</a></h3>
<p>Action chunking involves predicting a sequence of actions for multiple future time steps, starting at <code class="docutils literal notranslate"><span class="pre">t=0</span></code>. Initially, the model predicts actions for four future time steps, which the robot then executes sequentially. Once these actions are completed, at <code class="docutils literal notranslate"><span class="pre">t=4</span></code>, the model again predicts the next four actions. This pattern continues, allowing the robot to perform tasks by planning several steps ahead.</p>
</section>
<section id="action-chunking-with-temporal-ensembling">
<h3>Action Chunking with Temporal Ensembling<a class="headerlink" href="#action-chunking-with-temporal-ensembling" title="Link to this heading">#</a></h3>
<p>In the enhanced method combining Action Chunking and Temporal Ensembling, the model initially predicts four actions at <code class="docutils literal notranslate"><span class="pre">t=0</span></code> and executes the first action immediately. At each subsequent time step, such as <code class="docutils literal notranslate"><span class="pre">t=1</span></code>, the model predicts another set of four actions. To determine the next action to execute, the model averages the predictions from the current time step with the predictions from the previous time step. Specifically, it averages the current state‚Äôs prediction with the first state‚Äôs prediction from the new batch. This averaging process is used at each time step to smooth the trajectory of actions, ensuring that the robot‚Äôs motion is consistent.</p>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="algorithm">
<h1>Algorithm<a class="headerlink" href="#algorithm" title="Link to this heading">#</a></h1>
<p><img alt="" src="../../../_images/clipboard-4249152901.png" /></p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="code">
<h1>CODE<a class="headerlink" href="#code" title="Link to this heading">#</a></h1>
<section id="datset-prepare">
<h2>Datset Prepare<a class="headerlink" href="#datset-prepare" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>The<span class="w"> </span>datset<span class="w"> </span>structure

<span class="sb">`</span>Contents<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>HDF5<span class="w"> </span>file:
action:<span class="w"> </span>&lt;HDF5<span class="w"> </span>dataset<span class="w"> </span><span class="s2">&quot;action&quot;</span>:<span class="w"> </span>shape<span class="w"> </span><span class="o">(</span><span class="m">149</span>,<span class="w"> </span><span class="m">8</span><span class="o">)</span>,<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;&lt;f8&quot;</span>&gt;
<span class="w">  </span>-<span class="w"> </span>Shape:<span class="w"> </span><span class="o">(</span><span class="m">149</span>,<span class="w"> </span><span class="m">8</span><span class="o">)</span>,<span class="w"> </span>Type:<span class="w"> </span>float64
observations:<span class="w"> </span>&lt;HDF5<span class="w"> </span>group<span class="w"> </span><span class="s2">&quot;/observations&quot;</span><span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>members<span class="o">)</span>&gt;
<span class="w">    </span>images:<span class="w"> </span>&lt;HDF5<span class="w"> </span>group<span class="w"> </span><span class="s2">&quot;/observations/images&quot;</span><span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="w"> </span>members<span class="o">)</span>&gt;
<span class="w">        </span>top:<span class="w"> </span>&lt;HDF5<span class="w"> </span>dataset<span class="w"> </span><span class="s2">&quot;top&quot;</span>:<span class="w"> </span>shape<span class="w"> </span><span class="o">(</span><span class="m">149</span>,<span class="w"> </span><span class="m">480</span>,<span class="w"> </span><span class="m">640</span>,<span class="w"> </span><span class="m">3</span><span class="o">)</span>,<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;|u1&quot;</span>&gt;
<span class="w">          </span>-<span class="w"> </span>Shape:<span class="w"> </span><span class="o">(</span><span class="m">149</span>,<span class="w"> </span><span class="m">480</span>,<span class="w"> </span><span class="m">640</span>,<span class="w"> </span><span class="m">3</span><span class="o">)</span>,<span class="w"> </span>Type:<span class="w"> </span>uint8
<span class="w">    </span>qpos:<span class="w"> </span>&lt;HDF5<span class="w"> </span>dataset<span class="w"> </span><span class="s2">&quot;qpos&quot;</span>:<span class="w"> </span>shape<span class="w"> </span><span class="o">(</span><span class="m">149</span>,<span class="w"> </span><span class="m">8</span><span class="o">)</span>,<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;&lt;f8&quot;</span>&gt;
<span class="w">      </span>-<span class="w"> </span>Shape:<span class="w"> </span><span class="o">(</span><span class="m">149</span>,<span class="w"> </span><span class="m">8</span><span class="o">)</span>,<span class="w"> </span>Type:<span class="w"> </span>float64<span class="sb">`</span>
</pre></div>
</div>
<p>This code is in <code class="docutils literal notranslate"><span class="pre">live_record.py</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">controller.robot_state</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CameraController</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camera_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capture</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">camera_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="mi">640</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="mi">480</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_state_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recording</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">franka</span> <span class="o">=</span> <span class="n">RobotController</span><span class="p">()</span>
        <span class="c1"># self.franka.initial_pose()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">capture_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Press &#39;s&#39; to start/stop recording. Press &#39;q&#39; to quit.&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Camera Feed&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">recording</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recording started.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recording stopped. Saving data...&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">record_extra_frames</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">robot_state_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                    <span class="n">robot_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_robot_state</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Initial state with &#39;0&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">robot_state_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">robot_state</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_robot_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end_marker</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">franka</span><span class="o">.</span><span class="n">angles</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">angles</span><span class="p">,</span> <span class="p">[</span><span class="n">end_marker</span><span class="p">]))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">record_extra_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="n">last_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">last_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_robot_state</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Final state with &#39;1&#39;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">robot_state_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_state</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No data to save.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">episode_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s2">&quot;real_dir2&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;episode_</span><span class="si">{</span><span class="n">episode_idx</span><span class="si">}</span><span class="s1">.hdf5&#39;</span><span class="p">)):</span>
            <span class="n">episode_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;episode_</span><span class="si">{</span><span class="n">episode_idx</span><span class="si">}</span><span class="s1">.hdf5&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;observations&#39;</span><span class="p">)</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">)</span>
            <span class="n">camera_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cam_name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">camera_names</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]):</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
                <span class="n">images</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">cam_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">robot_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_state_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;qpos&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">robot_data</span><span class="p">)</span>
            <span class="n">root</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">robot_data</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">camera_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">camera_controller</span> <span class="o">=</span> <span class="n">CameraController</span><span class="p">(</span><span class="n">camera_index</span><span class="p">)</span>
    <span class="n">camera_controller</span><span class="o">.</span><span class="n">capture_frames</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="dataset-sampler">
<h2>Dataset Sampler<a class="headerlink" href="#dataset-sampler" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">einops</span><span class="w"> </span><span class="kn">import</span> <span class="n">rearrange</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>

<span class="c1"># from policy import ACTPolicy , CNNMLPPolicy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">policy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ACTPolicy</span> <span class="p">,</span> <span class="n">CNNMLPPolicy</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">IPython</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">embed</span>

<span class="k">class</span><span class="w"> </span><span class="nc">EpisodicDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">episode_ids</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="p">,</span> <span class="n">camera_names</span><span class="p">,</span> <span class="n">norm_stats</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EpisodicDataset</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episode_ids</span> <span class="o">=</span> <span class="n">episode_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">dataset_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_names</span> <span class="o">=</span> <span class="n">camera_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_stats</span> <span class="o">=</span> <span class="n">norm_stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_sim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#self.__getitem__(0) # initialize self.is_sim</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_ids</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">sample_full_episode</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># hardcode</span>

        <span class="n">episode_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_ids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">dataset_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;episode_</span><span class="si">{</span><span class="n">episode_id</span><span class="si">}</span><span class="s1">.hdf5&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">is_sim</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span>
            <span class="n">original_action_shape</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;/action&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">episode_len</span> <span class="o">=</span> <span class="n">original_action_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sample_full_episode</span><span class="p">:</span>
                <span class="n">start_ts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">episode_len</span><span class="p">)</span>
            <span class="c1"># get observation at start_ts only</span>
            <span class="n">qpos</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;/observations/qpos&#39;</span><span class="p">][</span><span class="n">start_ts</span><span class="p">]</span>
            <span class="c1"># qvel = root[&#39;/observations/qvel&#39;][start_ts]</span>
            <span class="n">image_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cam_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_names</span><span class="p">:</span>
                <span class="n">image_dict</span><span class="p">[</span><span class="n">cam_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;/observations/images/</span><span class="si">{</span><span class="n">cam_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">start_ts</span><span class="p">]</span>
            <span class="c1"># get all actions after and including start_ts</span>
            <span class="k">if</span> <span class="n">is_sim</span><span class="p">:</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;/action&#39;</span><span class="p">][</span><span class="n">start_ts</span><span class="p">:]</span>
                <span class="n">action_len</span> <span class="o">=</span> <span class="n">episode_len</span> <span class="o">-</span> <span class="n">start_ts</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;/action&#39;</span><span class="p">][</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_ts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):]</span> <span class="c1"># hack, to make timesteps more aligned</span>
                <span class="n">action_len</span> <span class="o">=</span> <span class="n">episode_len</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_ts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># hack, to make timesteps more aligned</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_sim</span> <span class="o">=</span> <span class="n">is_sim</span>
        <span class="n">padded_action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">original_action_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">padded_action</span><span class="p">[:</span><span class="n">action_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">action</span>
        <span class="n">is_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">episode_len</span><span class="p">)</span>
        <span class="n">is_pad</span><span class="p">[</span><span class="n">action_len</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># new axis for different cameras</span>
        <span class="n">all_cam_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cam_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_names</span><span class="p">:</span>
            <span class="n">all_cam_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_dict</span><span class="p">[</span><span class="n">cam_name</span><span class="p">])</span>
        <span class="n">all_cam_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">all_cam_images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># construct observations</span>
        <span class="n">image_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">all_cam_images</span><span class="p">)</span>
        <span class="n">qpos_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">action_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">padded_action</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">is_pad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">is_pad</span><span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>

        <span class="c1"># channel last</span>
        <span class="n">image_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;k h w c -&gt; k c h w&#39;</span><span class="p">,</span> <span class="n">image_data</span><span class="p">)</span>

        <span class="c1"># normalize image and change dtype to float</span>
        <span class="n">image_data</span> <span class="o">=</span> <span class="n">image_data</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="n">action_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">action_data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_stats</span><span class="p">[</span><span class="s2">&quot;action_mean&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_stats</span><span class="p">[</span><span class="s2">&quot;action_std&quot;</span><span class="p">]</span>
        <span class="n">qpos_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">qpos_data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_stats</span><span class="p">[</span><span class="s2">&quot;qpos_mean&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_stats</span><span class="p">[</span><span class="s2">&quot;qpos_std&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">image_data</span><span class="p">,</span> <span class="n">qpos_data</span><span class="p">,</span> <span class="n">action_data</span><span class="p">,</span> <span class="n">is_pad</span>
</pre></div>
</div>
<p>Here</p>
<p><code class="docutils literal notranslate"><span class="pre">image_data</span></code>: Sampling image data</p>
<p><code class="docutils literal notranslate"><span class="pre">qpos_data</span></code>: Positions (eg joint angles)</p>
<p><code class="docutils literal notranslate"><span class="pre">action_data</span></code>: Actions</p>
<p><code class="docutils literal notranslate"><span class="pre">is_pad</span></code> : It tells us how far it padded.</p>
</section>
<section id="policy">
<h2>Policy<a class="headerlink" href="#policy" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">transforms</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">detr.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_ACT_model_and_optimizer</span><span class="p">,</span> <span class="n">build_CNNMLP_model_and_optimizer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">IPython</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">embed</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ACTPolicy</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args_override</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">build_ACT_model_and_optimizer</span><span class="p">(</span><span class="n">args_override</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span> <span class="c1"># CVAE decoder conditional Variational Auto encoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kl_weight</span> <span class="o">=</span> <span class="n">args_override</span><span class="p">[</span><span class="s1">&#39;kl_weight&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;KL Weight </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_weight</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpos</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_pad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">env_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span>
                                         <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">actions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># training time</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="n">actions</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">num_queries</span><span class="p">]</span>
            <span class="n">is_pad</span> <span class="o">=</span> <span class="n">is_pad</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">num_queries</span><span class="p">]</span>

            <span class="n">a_hat</span><span class="p">,</span> <span class="n">is_pad_hat</span><span class="p">,</span> <span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">logvar</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">env_state</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">is_pad</span><span class="p">)</span>
            <span class="n">total_kld</span><span class="p">,</span> <span class="n">dim_wise_kld</span><span class="p">,</span> <span class="n">mean_kld</span> <span class="o">=</span> <span class="n">kl_divergence</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">logvar</span><span class="p">)</span>
            <span class="n">loss_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">all_l1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">l1_loss</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">a_hat</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="n">l1</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_l1</span> <span class="o">*</span> <span class="o">~</span><span class="n">is_pad</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">loss_dict</span><span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l1</span> <span class="c1"># regression loss </span>
            <span class="n">loss_dict</span><span class="p">[</span><span class="s1">&#39;kl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_kld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#</span>
            <span class="n">loss_dict</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_dict</span><span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">loss_dict</span><span class="p">[</span><span class="s1">&#39;kl&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_weight</span>
            <span class="k">return</span> <span class="n">loss_dict</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># inference time</span>
            <span class="n">a_hat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">env_state</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">a_hat</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span>
</pre></div>
</div>
</section>
<section id="training-code">
<h2>Training code<a class="headerlink" href="#training-code" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">train.py</span> <span class="pre">file</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">settings.var</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">training.utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>


<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--task&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">task</span>

<span class="c1"># configs</span>
<span class="n">task_cfg</span> <span class="o">=</span> <span class="n">TASK_CONFIG</span>
<span class="n">train_cfg</span> <span class="o">=</span> <span class="n">TRAIN_CONFIG</span>
<span class="n">policy_config</span> <span class="o">=</span> <span class="n">POLICY_CONFIG</span>
<span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_cfg</span><span class="p">[</span><span class="s1">&#39;checkpoint_dir&#39;</span><span class="p">],</span> <span class="n">task</span><span class="p">)</span>

<span class="c1"># device</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DEVICE&#39;</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">forward_pass</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
    <span class="n">image_data</span><span class="p">,</span> <span class="n">qpos_data</span><span class="p">,</span> <span class="n">action_data</span><span class="p">,</span> <span class="n">is_pad</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">qpos_data</span> <span class="o">=</span> <span class="n">qpos_data</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">action_data</span> <span class="o">=</span> <span class="n">action_data</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">image_data</span><span class="p">,</span> <span class="n">qpos_data</span><span class="p">,</span> <span class="n">action_data</span><span class="p">,</span> <span class="n">is_pad</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> 
    <span class="n">qpos_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">action_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">is_pad</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">policy</span><span class="p">(</span><span class="n">qpos_data</span><span class="p">,</span> <span class="n">image_data</span><span class="p">,</span> <span class="n">action_data</span><span class="p">,</span> <span class="n">is_pad</span><span class="p">)</span> <span class="c1"># TODO remove None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_history</span><span class="p">(</span><span class="n">train_history</span><span class="p">,</span> <span class="n">validation_history</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">ckpt_dir</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
    <span class="c1"># save training curves</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">train_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;train_val_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_seed_</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">train_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">summary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">summary</span> <span class="ow">in</span> <span class="n">train_history</span><span class="p">]</span>
        <span class="n">val_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">summary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">summary</span> <span class="ow">in</span> <span class="n">validation_history</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_history</span><span class="p">)),</span> <span class="n">train_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">validation_history</span><span class="p">)),</span> <span class="n">val_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;validation&#39;</span><span class="p">)</span>
        <span class="c1"># plt.ylim([-0.1, 1])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved plots to </span><span class="si">{</span><span class="n">ckpt_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train_bc</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">,</span> <span class="n">val_dataloader</span><span class="p">,</span> <span class="n">policy_config</span><span class="p">):</span>
    <span class="c1"># load policy</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">make_policy</span><span class="p">(</span><span class="n">policy_config</span><span class="p">[</span><span class="s1">&#39;policy_class&#39;</span><span class="p">],</span> <span class="n">policy_config</span><span class="p">)</span>
    <span class="n">policy</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># load optimizer</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">make_optimizer</span><span class="p">(</span><span class="n">policy_config</span><span class="p">[</span><span class="s1">&#39;policy_class&#39;</span><span class="p">],</span> <span class="n">policy</span><span class="p">)</span>

    <span class="c1"># create checkpoint dir if not exists</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">train_history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">validation_history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">min_val_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">best_ckpt_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_cfg</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># validation</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
            <span class="n">policy</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">epoch_dicts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val_dataloader</span><span class="p">):</span>
                <span class="n">forward_dict</span> <span class="o">=</span> <span class="n">forward_pass</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
                <span class="n">epoch_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">forward_dict</span><span class="p">)</span>
            <span class="n">epoch_summary</span> <span class="o">=</span> <span class="n">compute_dict_mean</span><span class="p">(</span><span class="n">epoch_dicts</span><span class="p">)</span>
            <span class="n">validation_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_summary</span><span class="p">)</span>

            <span class="n">epoch_val_loss</span> <span class="o">=</span> <span class="n">epoch_summary</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">epoch_val_loss</span> <span class="o">&lt;</span> <span class="n">min_val_loss</span><span class="p">:</span>
                <span class="n">min_val_loss</span> <span class="o">=</span> <span class="n">epoch_val_loss</span>
                <span class="n">best_ckpt_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">min_val_loss</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Val loss:   </span><span class="si">{</span><span class="n">epoch_val_loss</span><span class="si">:</span><span class="s1">.5f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">summary_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">epoch_summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">summary_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">summary_string</span><span class="p">)</span>

        <span class="c1"># training</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
            <span class="n">forward_dict</span> <span class="o">=</span> <span class="n">forward_pass</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
            <span class="c1"># backward</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">forward_dict</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">train_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">detach_dict</span><span class="p">(</span><span class="n">forward_dict</span><span class="p">))</span>
        <span class="n">epoch_summary</span> <span class="o">=</span> <span class="n">compute_dict_mean</span><span class="p">(</span><span class="n">train_history</span><span class="p">[(</span><span class="n">batch_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">epoch</span><span class="p">:(</span><span class="n">batch_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="n">epoch_summary</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train loss: </span><span class="si">{</span><span class="n">epoch_train_loss</span><span class="si">:</span><span class="s1">.5f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">summary_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">epoch_summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">summary_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">summary_string</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ckpt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;policy_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">_seed_</span><span class="si">{</span><span class="n">train_cfg</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.ckpt&quot;</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">ckpt_path</span><span class="p">)</span>
            <span class="n">plot_history</span><span class="p">(</span><span class="n">train_history</span><span class="p">,</span> <span class="n">validation_history</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">train_cfg</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">])</span>

    <span class="n">ckpt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;policy_last.ckpt&#39;</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">ckpt_path</span><span class="p">)</span>
    

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># set seed</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">train_cfg</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">])</span>
    <span class="c1"># create ckpt dir if not exists</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
   <span class="c1"># number of training episodes</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task_cfg</span><span class="p">[</span><span class="s1">&#39;dataset_dir&#39;</span><span class="p">],</span> <span class="n">task</span><span class="p">)</span>
    <span class="n">num_episodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>

    <span class="c1"># load data</span>
    <span class="n">train_dataloader</span><span class="p">,</span> <span class="n">val_dataloader</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">num_episodes</span><span class="p">,</span> <span class="n">task_cfg</span><span class="p">[</span><span class="s1">&#39;camera_names&#39;</span><span class="p">],</span>
                                                            <span class="n">train_cfg</span><span class="p">[</span><span class="s1">&#39;batch_size_train&#39;</span><span class="p">],</span> <span class="n">train_cfg</span><span class="p">[</span><span class="s1">&#39;batch_size_val&#39;</span><span class="p">])</span>

    <span class="c1"># save stats</span>
    <span class="n">stats_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;dataset_stats.pkl&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stats_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># train</span>
    <span class="n">train_bc</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">,</span> <span class="n">val_dataloader</span><span class="p">,</span> <span class="n">policy_config</span><span class="p">)</span>


<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The data loader is very important bcs we are pluging our input data here </span>

<span class="sd">    The data lodaer like an iterator or a smampler that samples each part of the data</span>

<span class="sd">    were we will have the training data validation data and statastics which is just to normalize our data</span>

<span class="sd">    &#39;&#39;&#39;</span>
</pre></div>
</div>
</section>
<section id="model">
<h2>Model<a class="headerlink" href="#model" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.autograd</span><span class="w"> </span><span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.backbone</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_backbone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.transformer</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_transformer</span><span class="p">,</span> <span class="n">TransformerEncoder</span><span class="p">,</span> <span class="n">TransformerEncoderLayer</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">IPython</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">embed</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">reparametrize</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">logvar</span><span class="p">):</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">logvar</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">std</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">std</span><span class="o">.</span><span class="n">size</span><span class="p">())</span><span class="o">.</span><span class="n">normal_</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">std</span> <span class="o">*</span> <span class="n">eps</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_sinusoid_encoding_table</span><span class="p">(</span><span class="n">n_position</span><span class="p">,</span> <span class="n">d_hid</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_position_angle_vec</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">position</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">hid_j</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_hid</span><span class="p">)</span> <span class="k">for</span> <span class="n">hid_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d_hid</span><span class="p">)]</span>

    <span class="n">sinusoid_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_position_angle_vec</span><span class="p">(</span><span class="n">pos_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_position</span><span class="p">)])</span>
    <span class="n">sinusoid_table</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">sinusoid_table</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># dim 2i</span>
    <span class="n">sinusoid_table</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sinusoid_table</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># dim 2i+1</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">sinusoid_table</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DETRVAE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This is the DETR module that performs object detection &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backbones</span><span class="p">,</span> <span class="n">transformer</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span> <span class="n">num_queries</span><span class="p">,</span> <span class="n">camera_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initializes the model.</span>
<span class="sd">        Parameters:</span>
<span class="sd">            backbones: torch module of the backbone to be used. See backbone.py</span>
<span class="sd">            transformer: torch module of the transformer architecture. See transformer.py</span>
<span class="sd">            state_dim: robot state dimension of the environment</span>
<span class="sd">            num_queries: number of object queries, ie detection slot. This is the maximal number of objects</span>
<span class="sd">                         DETR can detect in a single image. For COCO, we recommend 100 queries.</span>
<span class="sd">            aux_loss: True if auxiliary decoding losses (loss at each decoder layer) are to be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_queries</span> <span class="o">=</span> <span class="n">num_queries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_names</span> <span class="o">=</span> <span class="n">camera_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span>
        <span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">d_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_pad_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_queries</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">backbones</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">backbones</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backbones</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span><span class="n">backbones</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_proj_robot_state</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># input_dim = 14 + 7 # robot_state + env_state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_proj_robot_state</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_proj_env_state</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backbones</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># encoder extra parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># final size of latent z # TODO tune </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span> <span class="c1"># extra cls token embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_action_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span> <span class="c1"># project action to embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_joint_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>  <span class="c1"># project qpos to embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latent_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># project hidden state to latent std, var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;pos_table&#39;</span><span class="p">,</span> <span class="n">get_sinusoid_encoding_table</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">num_queries</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">))</span> <span class="c1"># [CLS], qpos, a_seq</span>

        <span class="c1"># decoder extra parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latent_out_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span> <span class="c1"># project latent sample to embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additional_pos_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span> <span class="c1"># learned position embedding for proprio and latent</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpos</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">env_state</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_pad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        qpos: batch, qpos_dim</span>
<span class="sd">        image: batch, num_cam, channel, height, width</span>
<span class="sd">        env_state: None</span>
<span class="sd">        actions: batch, seq, action_dim</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_training</span> <span class="o">=</span> <span class="n">actions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="c1"># train or val</span>
        <span class="n">bs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">qpos</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># actions = actions.to(torch.float32) if actions is not None else actions</span>
        <span class="c1"># qpos = qpos.to(torch.float32)</span>
        <span class="c1"># image = image.to(torch.float32)</span>
        <span class="c1">### Obtain latent z from action sequence</span>
        <span class="k">if</span> <span class="n">is_training</span><span class="p">:</span>
            <span class="c1"># project action sequence to embedding dim, and concat with a CLS token</span>
            <span class="n">action_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_action_proj</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="c1"># (bs, seq, hidden_dim)</span>
            <span class="n">qpos_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_joint_proj</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>  <span class="c1"># (bs, hidden_dim)</span>
            <span class="n">qpos_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">qpos_embed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (bs, 1, hidden_dim)</span>
            <span class="n">cls_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_embed</span><span class="o">.</span><span class="n">weight</span> <span class="c1"># (1, hidden_dim)</span>
            <span class="n">cls_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">cls_embed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># (bs, 1, hidden_dim)</span>
            <span class="n">encoder_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">cls_embed</span><span class="p">,</span> <span class="n">qpos_embed</span><span class="p">,</span> <span class="n">action_embed</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># (bs, seq+1, hidden_dim)</span>
            <span class="n">encoder_input</span> <span class="o">=</span> <span class="n">encoder_input</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># (seq+1, bs, hidden_dim)</span>
            <span class="c1"># do not mask cls token</span>
            <span class="n">cls_joint_is_pad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">qpos</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># False: not a padding</span>

            <span class="n">is_pad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">cls_joint_is_pad</span><span class="p">,</span> <span class="n">is_pad</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (bs, seq+1)</span>
            <span class="c1"># obtain position embedding</span>
            <span class="n">pos_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_table</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="n">pos_embed</span> <span class="o">=</span> <span class="n">pos_embed</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># (seq+1, 1, hidden_dim)</span>
            <span class="c1"># query model</span>
            <span class="n">encoder_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">encoder_input</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos_embed</span><span class="p">,</span> <span class="n">src_key_padding_mask</span><span class="o">=</span><span class="n">is_pad</span><span class="p">)</span>
            <span class="n">encoder_output</span> <span class="o">=</span> <span class="n">encoder_output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># take cls output only</span>
            <span class="n">latent_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_proj</span><span class="p">(</span><span class="n">encoder_output</span><span class="p">)</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">latent_info</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">]</span>
            <span class="n">logvar</span> <span class="o">=</span> <span class="n">latent_info</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">:]</span>
            <span class="n">latent_sample</span> <span class="o">=</span> <span class="n">reparametrize</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">logvar</span><span class="p">)</span>
            <span class="n">latent_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_out_proj</span><span class="p">(</span><span class="n">latent_sample</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">logvar</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">latent_sample</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">bs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">qpos</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="n">latent_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_out_proj</span><span class="p">(</span><span class="n">latent_sample</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbones</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Image observation features and position embeddings</span>
            <span class="n">all_cam_features</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_cam_pos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cam_id</span><span class="p">,</span> <span class="n">cam_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_names</span><span class="p">):</span>
                <span class="n">features</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbones</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">image</span><span class="p">[:,</span> <span class="n">cam_id</span><span class="p">])</span> <span class="c1"># HARDCODED for single back bone</span>
                <span class="c1"># features, pos = self.backbones[cam_id](image[:, cam_id])</span>

                <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># take the last layer feature</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">all_cam_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_proj</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
                <span class="n">all_cam_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="c1"># proprioception features</span>
            <span class="n">proprio_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_proj_robot_state</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
            <span class="c1"># fold camera dimension into width dimension</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_cam_features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_cam_pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">hs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_embed</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">latent_input</span><span class="p">,</span> <span class="n">proprio_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_pos_embed</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_proj_robot_state</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
            <span class="n">env_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_proj_env_state</span><span class="p">(</span><span class="n">env_state</span><span class="p">)</span>
            <span class="n">transformer_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">qpos</span><span class="p">,</span> <span class="n">env_state</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># seq length = 2</span>
            <span class="n">hs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">(</span><span class="n">transformer_input</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_embed</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">weight</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_head</span><span class="p">(</span><span class="n">hs</span><span class="p">)</span>
        <span class="n">is_pad_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_pad_head</span><span class="p">(</span><span class="n">hs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a_hat</span><span class="p">,</span> <span class="n">is_pad_hat</span><span class="p">,</span> <span class="p">[</span><span class="n">mu</span><span class="p">,</span> <span class="n">logvar</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_encoder</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">d_model</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="c1"># 256</span>
    <span class="n">dropout</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dropout</span> <span class="c1"># 0.1</span>
    <span class="n">nhead</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">nheads</span> <span class="c1"># 8</span>
    <span class="n">dim_feedforward</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dim_feedforward</span> <span class="c1"># 2048</span>
    <span class="n">num_encoder_layers</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">enc_layers</span> <span class="c1"># 4 # TODO shared with VAE decoder</span>
    <span class="n">normalize_before</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pre_norm</span> <span class="c1"># False</span>
    <span class="n">activation</span> <span class="o">=</span> <span class="s2">&quot;relu&quot;</span>

    <span class="n">encoder_layer</span> <span class="o">=</span> <span class="n">TransformerEncoderLayer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">nhead</span><span class="p">,</span> <span class="n">dim_feedforward</span><span class="p">,</span>
                                            <span class="n">dropout</span><span class="p">,</span> <span class="n">activation</span><span class="p">,</span> <span class="n">normalize_before</span><span class="p">)</span>
    <span class="n">encoder_norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span> <span class="k">if</span> <span class="n">normalize_before</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">encoder</span> <span class="o">=</span> <span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">encoder_layer</span><span class="p">,</span> <span class="n">num_encoder_layers</span><span class="p">,</span> <span class="n">encoder_norm</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">encoder</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">state_dim</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># TODO hardcode</span>

    <span class="c1"># From state</span>
    <span class="c1"># backbone = None # from state for now, no need for conv nets</span>
    <span class="c1"># From image</span>
    <span class="n">backbones</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">backbone</span> <span class="o">=</span> <span class="n">build_backbone</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">backbones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">backbone</span><span class="p">)</span>

    <span class="n">transformer</span> <span class="o">=</span> <span class="n">build_transformer</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">encoder</span> <span class="o">=</span> <span class="n">build_encoder</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">DETRVAE</span><span class="p">(</span>
        <span class="n">backbones</span><span class="p">,</span>
        <span class="n">transformer</span><span class="p">,</span>
        <span class="n">encoder</span><span class="p">,</span>
        <span class="n">state_dim</span><span class="o">=</span><span class="n">state_dim</span><span class="p">,</span>
        <span class="n">num_queries</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_queries</span><span class="p">,</span>
        <span class="n">camera_names</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">camera_names</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">n_parameters</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of parameters: </span><span class="si">%.2f</span><span class="s2">M&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_parameters</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,))</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../Bluetooth/index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Blog</p>
      </div>
    </a>
    <a class="right-next"
       href="../isaacsim/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Isaac Sim</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Vision Guided Imitation Learning using Action Chunk Transformer</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#transformer">Transformer</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#encoder">Encoder</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-head-attention">Multi-head Attention</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decoder">Decoder</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#main-overview-of-the-act">Main Overview of the ACT</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1">STEP 1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2">STEP 2</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#system-overview">System Overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-input-and-cnn-processing">Image Input and CNN Processing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-tokenization-and-transformer-encoding">Feature Tokenization and Transformer Encoding</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decoding-and-output-prediction">Decoding and Output Prediction</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#temporial-ensembling">Temporial Ensembling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#action-chunking">Action Chunking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#action-chunking-with-temporal-ensembling">Action Chunking with Temporal Ensembling</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#algorithm">Algorithm</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#code">CODE</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#datset-prepare">Datset Prepare</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset-sampler">Dataset Sampler</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#policy">Policy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-code">Training code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model">Model</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Navaneet
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2025, Navaneet.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>